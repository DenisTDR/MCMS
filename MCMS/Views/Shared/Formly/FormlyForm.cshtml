@using MCMS.SwaggerFormly.Extensions
@using Newtonsoft.Json
@using MCMS.Base.Extensions
@using MCMS.Base.Helpers
@model MCMS.SwaggerFormly.Models.FormlyFormParams
@if (!Env.GetBool("FORMLY_DEBUG"))
{
    <ce-formly-form-params
        schema-name="@Model.SchemaName"
        model-id="@Model.ModelId"
        action="@Model.Action.GetCustomValue()"
        get-url="@Model.GetUrl"
        submit-url="@Model.SubmitUrl"
        additional-fields="@JsonConvert.SerializeObject(Model.AdditionalFields, Utils.DefaultJsonSerializerSettings())"
        id="@Model.FormInstanceId"
        form-instance-id="@Model.FormInstanceId"
        options="@JsonConvert.SerializeObject(Model.Options, Utils.DefaultJsonSerializerSettings())">
        Loading form ... (check developer console if you still see this)
    </ce-formly-form-params>
}
else
{
    <iframe src="/formly-proxy?@Model.ToUrlQuery()" class="col-12" id="@Model.FormInstanceId"></iframe>
}
@using (Html.BeginMPageScripts())
{
    <script>
        function formDone@(Model.FormInstanceId)(e) {
            // console.log('done, ', e)
            var callbackName = 'callback@(Model.FormInstanceId)';
            if(window.hasOwnProperty(callbackName)) {
                window[callbackName](e.senderId, e.params);
            }
        }
    </script>
    @if (!Env.GetBool("FORMLY_DEBUG"))
    {
        <script>
            var formElement = document.getElementById('@Model.FormInstanceId');
            formElement.addEventListener('done', function(e) { formDone@(Model.FormInstanceId)(e.detail); });
            $("#@Model.FormInstanceId-submit-button").on('click', function() {
                $("#@Model.FormInstanceId .submit-button").click();
            });
        </script>
    }
    else
    {
        <script>
              window.addEventListener('message', function(e){
                  if(!e || !e.data || !e.data.id || e.data.senderId !== '@Model.FormInstanceId') {
                      return;
                  }
                  if(e.data.id === 'formly-form-height-changed') {
                      var iFrame = document.getElementById("@Model.FormInstanceId");
                      if(iFrame) {
                          iFrame.style.height = e.data.height + 50 + "px";
                      }
                  }  else if(e.data.id === 'formly-form-done') {
                      formDone@(Model.FormInstanceId)(e.data.data); 
                  }
              });
              
              $("#@Model.FormInstanceId-submit-button").on('click', function() {
                document.getElementById("@Model.FormInstanceId").contentWindow.postMessage({submitForm: true}, '*');
              });
        </script>
    }
}