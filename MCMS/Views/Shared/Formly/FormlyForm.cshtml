@using MCMS.Helpers
@using MCMS.SwaggerFormly.Extensions
@using Newtonsoft.Json
@using Utils = MCMS.Helpers.Utils
@using MCMS.Base.Extensions
@model MCMS.SwaggerFormly.Models.FormlyFormParams
@{
    var iframeId = "formly-form-" + Utils.GenerateRandomHexString();
}
@if (!Env.GetBool("FORMLY_DEBUG"))
{
    <ce-formly-form-params
        schema-name="@Model.SchemaName"
        model-id="@Model.ModelId"
        action="@Model.Action.GetCustomValue()"
        get-url="@Model.GetUrl"
        submit-url="@Model.SubmitUrl"
        additional-fields="@JsonConvert.SerializeObject(Model.AdditionalFields, Utils.JsonSerializerSettings())"
        id="@Model.FormInstanceId"
        form-instance-id="@Model.FormInstanceId">
        Loading form ... (check developer console if you still see this)
    </ce-formly-form-params>
}
else
{
    <iframe src="/formly-proxy?@Model.ToUrlQuery()" class="col-12" id="@iframeId"></iframe>
}
@using (Html.BeginMScripts())
{
    <script>
        function formDone@(Model.FormInstanceId)(e) {
            console.log('done, ', e)
        }
    </script>
    @if (!Env.GetBool("FORMLY_DEBUG"))
    {
        <script>
        var formElement = document.getElementById('@Model.FormInstanceId');
        formElement.addEventListener('done', function(e) { formDone@(Model.FormInstanceId)(e.detail); });
        </script>
    }
    else
    {
        @using (Html.BeginMScripts())
        {
            <script>
              window.addEventListener('message', function(e){
                  if(!e || !e.data || !e.data.id || e.data.senderId !== '@Model.FormInstanceId') {
                      return;
                  }
                  if(e.data.id === 'formly-form-height-changed') {
                      var iFrame = document.getElementById("@iframeId");
                      if(iFrame) {
                          iFrame.style.height = e.data.height + 50 + "px";
                      }
                  }  else if(e.data.id === 'formly-form-done') {
                      formDone@(Model.FormInstanceId)(e.data.data); 
                  }
              });
            </script>
        }
    }
}